/*! Unspoiler - v2.2.0 - 2014-01-23 */function onTabActivated(a){chrome.tabs.get(a.tabId,function(a){filterTab(a)})}function onTabUpdated(a,b,c){filterTab(c)}function filterTab(a){if(a){var b=!0,c=a.url.substring(0,unspoilerdomain.length)===unspoilerdomain,d=a.url.substring(0,devdomain.length)===devdomain;(c||d)&&(apidomain=c?unspoilerdomain:devdomain,b=!1,getSyncStatus(function(a){a.isSyncNeeded&&syncStorage()})),getWhitesites(function(c){for(var d in c)a.url.indexOf(c[d])>-1&&(b=!1);b&&getTags(function(b){sendFilterRequest(b,a.id)})})}}function getSyncStatus(a){chrome.storage.sync.get("isSyncNeeded",function(b){b||(b={isSyncNeeded:!0}),b.isSyncNeeded=b.isSyncNeeded||"true"===b.isSyncNeeded?!0:!1,b.method="getSyncStatus",a(b)})}function syncStorage(){getTags(function(a){var b={tags:a},c=new XMLHttpRequest;c.open("POST",apidomain+"/api/synctags",!0),c.setRequestHeader("Content-type","application/json"),c.send(JSON.stringify(b)),c.onreadystatechange=function(){4==this.readyState&&(chrome.runtime.sendMessage({method:"syncComplete"},function(){}),chrome.tabs.query({active:!0},function(a){chrome.tabs.sendMessage(a[0].id,{method:"syncComplete"},function(){})}),getSpoilers(function(a){if(0===a.length)return void setSyncStatus(!1);var b={spoilers:a},c=new XMLHttpRequest;c.open("POST",apidomain+"/api/syncspoilers",!0),c.setRequestHeader("Content-type","application/json"),c.send(JSON.stringify(b)),c.onreadystatechange=function(){4==this.readyState&&200==this.status&&(setSyncStatus(!1),clearSpoilers())}}))}})}chrome.omnibox.onInputEntered.addListener(saveTag),chrome.tabs.onActivated.addListener(onTabActivated),chrome.tabs.onUpdated.addListener(onTabUpdated);var apidomain,devdomain="http://localhost:8080",unspoilerdomain="http://www.unspoiler.tv",clearSpoilers=function(){chrome.storage.sync.set({spoilers:[]},function(){})},saveSpoiler=function(a){getSpoilers(function(b){b||(b=[]),b.push(a),chrome.storage.sync.set({spoilers:b},function(){setSyncStatus(!0)})})};chrome.runtime.onMessage.addListener(function(a,b){a.method&&("getFlagStatus"==a.method&&chrome.storage.sync.get("showFlag",function(a){null==a.showFlag&&(a={showFlag:!0}),a.method="getFlagStatus",chrome.tabs.sendMessage(b.tab.id,a)}),"filterTab"==a.method&&filterTab(b.tab),"setFlagOff"==a.method&&chrome.storage.sync.set({showFlag:!1},function(){}),"saveSpoiler"==a.method&&saveSpoiler(a.data))});